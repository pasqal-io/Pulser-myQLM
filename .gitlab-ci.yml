# Official language image. Look for the different tagged releases at:
# https://hub.docker.com/r/library/python/tags/
default:
  image: python:3.9

stages:
  - pre-commit
  - test
  - build-push
  - docker-test

# Change pip's cache directory to be inside the project directory since we can
# only cache local items.
variables:
  PIP_CACHE_DIR: "$CI_PROJECT_DIR/.cache/pip"
  REGISTRY_URL: ${PCS_HARBOR_URL}
  DOCKER_IMAGE: "$REGISTRY_URL/pulser-myqlm/pulser-myqlm"
  DOCKER_TAG: "$CI_COMMIT_REF_SLUG"

# Pip's cache doesn't store the python packages
# https://pip.pypa.io/en/stable/topics/caching/

cache:
  paths:
    - .cache/pip

before_script:
  - python --version # For debugging
  - python -m pip install --upgrade pip
  - pip install -e .
  - pip install -r dev_requirements.txt

black:
  stage: pre-commit
  script:
    - black --check --diff .

isort:
  stage: pre-commit
  script:
    - isort --check-only --diff .

style:
  stage: pre-commit
  script:
    - flake8

typing:
  stage: pre-commit
  script:
    - mypy

test:
  stage: test
  script:
    - pytest --cov --cov-fail-under=100 ./tests

build_and_push:
  stage: build-push
  image: ${REGISTRY_URL}/public/docker:cli
  before_script:
    - until docker info; do sleep 1; done
    - echo ${PCS_HARBOR_PASSWORD} | docker login --username ${PCS_HARBOR_USERNAME} --password-stdin ${REGISTRY_URL}
  script:
    - docker build -t $DOCKER_IMAGE:$DOCKER_TAG -f ./containerized/pulser_myqlm.Dockerfile .
    - docker push $DOCKER_IMAGE:$DOCKER_TAG
    - |
      if [ "$CI_COMMIT_REF_NAME" == "$CI_DEFAULT_BRANCH" ]; then
        docker tag $DOCKER_IMAGE:$DOCKER_TAG $DOCKER_IMAGE:latest
        docker push $DOCKER_IMAGE:latest
      fi

docker-test:
  stage: docker-test
  image: $DOCKER_IMAGE:$DOCKER_TAG
  before_script:
    - echo ${PCS_HARBOR_PASSWORD} | docker login --username ${PCS_HARBOR_USERNAME} --password-stdin ${REGISTRY_URL}
  script:
    - docker run --rm $DOCKER_IMAGE:$DOCKER_TAG
  dependencies:
    - build_and_push
